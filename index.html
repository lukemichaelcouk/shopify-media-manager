<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>SPREE - Shopify Media Manager v3-DEBUG</title>
    <meta name="description" content="Professional Shopify media management tool by SPREE agency. Download, optimize, and reupload your store's media files with ease.">
    <meta name="keywords" content="Shopify, media manager, image optimization, SPREE, agency, e-commerce">
    <meta name="author" content="SPREE Agency">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://wearespree.com/img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://wearespree.com/img/favicon/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://wearespree.com/img/favicon/apple-touch-icon.png">
    <meta name="theme-color" content="#312A72">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://media-manager.wearespree.com/">
    <meta property="og:title" content="SPREE - Shopify Media Manager">
    <meta property="og:description" content="Professional Shopify media management tool by SPREE agency. Download, optimize, and reupload your store's media files with ease.">
    <meta property="og:image" content="https://wearespree.com/img/spree-logo.svg">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://media-manager.wearespree.com/">
    <meta property="twitter:title" content="SPREE - Shopify Media Manager">
    <meta property="twitter:description" content="Professional Shopify media management tool by SPREE agency. Download, optimize, and reupload your store's media files with ease.">
    <meta property="twitter:image" content="https://wearespree.com/img/spree-logo.svg">
    
    <!-- Google Fonts - Lexend -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- JSZip for creating ZIP files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Shopify App Bridge -->
    <script src="https://unpkg.com/@shopify/app-bridge@3"></script>
    <!-- Image Optimizer for client-side analysis -->
    <script src="image-optimizer.js"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="spree-branding">
                <img src="https://wearespree.com/img/spree-logo.svg" alt="SPREE Agency" class="spree-logo">
                <div class="app-title">
                    <h1><i class="fab fa-shopify"></i> Shopify Media Manager</h1>
                    <p>Download, optimize, and reupload your store's media files</p>
                    <span class="powered-by">Powered by SPREE Agency</span>
                </div>
            </div>
        </header>

        <!-- Installation/Loading Section -->
        <section id="installation-section" class="section">
            <div class="card">
                <div id="loading-state" class="loading-state">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p>Setting up your Shopify Media Manager...</p>
                </div>
                
                <div id="install-prompt" class="install-prompt hidden">
                    <h2><i class="fas fa-download"></i> Install Shopify Media Manager</h2>
                    <p>Click the button below to install and connect your Shopify store.</p>
                    <button id="install-btn" class="btn btn-primary">
                        <i class="fab fa-shopify"></i> Install App
                    </button>
                </div>

                <div id="auth-error" class="auth-error hidden">
                    <h2><i class="fas fa-exclamation-triangle"></i> Installation Required</h2>
                    <p>Please install this app through your Shopify admin panel.</p>
                    <button id="retry-auth" class="btn btn-secondary">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            </div>
        </section>

        <!-- Authentication Section -->
        <section id="auth-section" class="section hidden">
            <div class="card">
                <h2><i class="fas fa-key"></i> Store Connection</h2>
                <div id="connection-status" class="status-disconnected">
                    <i class="fas fa-times-circle"></i> Not Connected
                </div>
                <button id="connect-btn" class="btn btn-primary">
                    <i class="fab fa-shopify"></i> Connect to Shopify Store
                </button>
                <div id="store-info" class="store-info hidden">
                    <h3>Connected Store</h3>
                    <p><strong>Store:</strong> <span id="store-name"></span></p>
                    <p><strong>Domain:</strong> <span id="store-domain"></span></p>
                    <button id="disconnect-btn" class="btn btn-secondary">
                        <i class="fas fa-sign-out-alt"></i> Disconnect
                    </button>
                </div>
            </div>
        </section>

        <!-- Media Management Section -->
        <section id="media-section" class="section hidden">
            <div class="card">
                <h2><i class="fas fa-images"></i> Media Management</h2>
                
                <!-- Fetch All Images Button -->
                <div style="margin-bottom: 1em;">
                    <button id="fetch-images-btn" class="btn btn-primary">Fetch All Image Assets</button>
                    <button id="refresh-images-btn" class="btn btn-secondary" style="margin-left: 10px;">
                        <i class="fas fa-sync"></i> Refresh Images
                    </button>
                    <button id="fetch-metadata-btn" class="btn btn-info hidden" style="margin-left: 10px;">
                        <i class="fas fa-info-circle"></i> Re-analyze Images
                    </button>
                    <span id="images-status" style="margin-left: 1em; color: #888;"></span>
                </div>
                
                <!-- Image Filters -->
                <div id="image-filters" class="hidden" style="margin-bottom: 1em; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="filterImages('all')" class="btn btn-outline filter-btn active" data-filter="all">
                        <i class="fas fa-images"></i> All Images (<span id="count-all">0</span>)
                    </button>
                    <button onclick="filterImages('theme')" class="btn btn-outline filter-btn" data-filter="theme">
                        <i class="fas fa-palette"></i> Theme Images (<span id="count-theme">0</span>)
                    </button>
                    <button onclick="filterImages('products')" class="btn btn-outline filter-btn" data-filter="products">
                        <i class="fas fa-box"></i> Product Images (<span id="count-products">0</span>)
                    </button>
                    <button onclick="filterImages('collections')" class="btn btn-outline filter-btn" data-filter="collections">
                        <i class="fas fa-layer-group"></i> Collection Images (<span id="count-collections">0</span>)
                    </button>
                    <button onclick="filterImages('oversized')" class="btn btn-outline filter-btn" data-filter="oversized">
                        <i class="fas fa-exclamation-triangle"></i> Oversized Images (<span id="count-oversized">0</span>)
                    </button>
                    <div id="file-type-filters" class="file-type-filters" style="display: flex; gap: 8px; flex-wrap: wrap; margin-left: 10px; padding-left: 10px; border-left: 1px solid #ddd;">
                        <!-- File type filters will be dynamically added here after analysis -->
                    </div>
                </div>
                
                <!-- Image Gallery -->
                <div id="image-gallery" class="image-gallery"></div>
                
                <!-- Download Controls -->
                <div id="download-controls" class="download-controls hidden">
                    <div class="selection-controls">
                        <button onclick="selectAllImages()" class="btn btn-outline btn-small">
                            <i class="fas fa-check-double"></i> Select All
                        </button>
                        <button onclick="selectNoneImages()" class="btn btn-outline btn-small">
                            <i class="fas fa-times"></i> Select None
                        </button>
                        <span id="selection-count" class="selection-status">0 selected</span>
                    </div>
                    <div class="download-buttons">
                        <button id="download-all-btn" onclick="downloadAllImages()" class="btn btn-success">
                            <i class="fas fa-file-archive"></i> Download All as ZIP
                        </button>
                        <button id="download-selected-btn" onclick="downloadSelectedImages()" class="btn btn-info" disabled>
                            <i class="fas fa-file-archive"></i> Download Selected as ZIP
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Statistics Section -->
        <section id="stats-section" class="section hidden">
            <div class="card">
                <h2><i class="fas fa-chart-bar"></i> Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label">Total Files:</span>
                        <span id="total-files" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Total Size:</span>
                        <span id="total-size" class="stat-value">0 MB</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Oversized Files:</span>
                        <span id="oversized-count" class="stat-value">0</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Notifications -->
        <div id="notifications" class="notifications"></div>
    </div>

    <script>
        // Global app state
        window.shopifyApp = {
            shop: null,
            accessToken: null,
            bridge: null
        };

        // Session storage for images
        const imageSession = {
            images: [],
            lastFetched: null,
            shop: null,
            
            save: function(images, shop) {
                this.images = images;
                this.lastFetched = new Date().toISOString();
                this.shop = shop;
                sessionStorage.setItem('shopify_media_session', JSON.stringify({
                    images: this.images,
                    lastFetched: this.lastFetched,
                    shop: this.shop
                }));
                console.log(`Saved ${images.length} images to session for shop ${shop}`);
            },
            
            load: function() {
                try {
                    const stored = sessionStorage.getItem('shopify_media_session');
                    if (stored) {
                        const data = JSON.parse(stored);
                        this.images = data.images || [];
                        this.lastFetched = data.lastFetched;
                        this.shop = data.shop;
                        console.log(`Loaded ${this.images.length} images from session for shop ${this.shop}`);
                        return true;
                    }
                } catch (error) {
                    console.warn('Failed to load session data:', error);
                }
                return false;
            },
            
            clear: function() {
                this.images = [];
                this.lastFetched = null;
                this.shop = null;
                sessionStorage.removeItem('shopify_media_session');
                console.log('Cleared image session');
            },
            
            isValid: function(shop) {
                return this.shop === shop && this.images.length > 0 && this.lastFetched;
            },
            
            getAge: function() {
                if (!this.lastFetched) return 0;
                return (new Date() - new Date(this.lastFetched)) / 1000; // seconds
            }
        };

        // Utility function to extract file extension from URL, stripping query strings and fragments
        function getFileExtension(url) {
            return url.split('.').pop().split('?')[0].split('#')[0].toLowerCase();
        }

        // Utility function to infer image type from URL
        function inferImageType(url) {
            const extension = getFileExtension(url);
            const imageExtensions = {
                'jpg': 'JPEG',
                'jpeg': 'JPEG',
                'png': 'PNG',
                'gif': 'GIF',
                'webp': 'WebP',
                'svg': 'SVG',
                'bmp': 'BMP',
                'tiff': 'TIFF',
                'tif': 'TIFF',
                'ico': 'ICO',
                'avif': 'AVIF'
            };
            
            return imageExtensions[extension] || extension.toUpperCase() || 'UNKNOWN';
        }

        // Check for URL parameters on page load
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const shop = urlParams.get('shop');
            const token = urlParams.get('token');
            const hmac = urlParams.get('hmac');
            const host = urlParams.get('host');

            console.log('Page loaded with params:', { shop, token: token ? 'present' : 'missing', hmac: hmac ? 'present' : 'missing' });
            console.log('Full URL:', window.location.href);
            console.log('Search params:', window.location.search);

            // Check for stored authentication first
            const storedShop = localStorage.getItem('shopify_shop');
            const storedToken = localStorage.getItem('shopify_token');

            if (shop && token) {
                // We have shop and token from OAuth callback - store them and initialize
                console.log('✅ OAuth success detected - storing credentials and initializing app');
                localStorage.setItem('shopify_shop', shop);
                localStorage.setItem('shopify_token', token);
                
                // Clean up URL parameters immediately
                const cleanUrl = window.location.protocol + '//' + window.location.host + window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
                
                // Initialize app with the new credentials
                validateAndInitializeApp(shop, token);
            } else if (storedShop && storedToken) {
                // Use stored authentication - but validate it first
                console.log('Found stored authentication for shop:', storedShop);
                validateAndInitializeApp(storedShop, storedToken);
            } else if (shop && hmac) {
                // This is an installation request from Shopify
                console.log('Installation request detected');
                showInstallPrompt(shop);
            } else if (shop && !hmac && !token) {
                // Custom app access - shop parameter but no auth
                console.log('Custom app access detected for shop:', shop);
                showCustomAppPrompt(shop);
            } else {
                // No shop parameter - show manual connection
                console.log('No shop parameter - showing manual connection');
                showManualConnection();
            }
        });

        async function validateAndInitializeApp(shop, accessToken) {
            console.log('Validating token for shop:', shop);
            
            try {
                const response = await fetch('/api/validate-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ shop, accessToken })
                });
                
                const result = await response.json();
                
                if (result.valid) {
                    console.log('Token is valid, initializing authenticated app');
                    initializeAuthenticatedApp(shop, accessToken);
                } else {
                    console.log('Token is invalid, clearing stored credentials');
                    localStorage.removeItem('shopify_shop');
                    localStorage.removeItem('shopify_token');
                    showNotification('Your session has expired. Please reconnect.', 'warning');
                    showManualConnection();
                }
            } catch (error) {
                console.error('Token validation failed:', error);
                showNotification('Failed to validate session. Please try reconnecting.', 'error');
                showManualConnection();
            }
        }

        function initializeAuthenticatedApp(shop, accessToken) {
            console.log('🚀 initializeAuthenticatedApp called with:', { shop, token: accessToken ? 'present' : 'missing' });
            
            window.shopifyApp.shop = shop;
            window.shopifyApp.accessToken = accessToken;
            
            console.log('✅ Credentials set in window.shopifyApp:', window.shopifyApp);

            // Hide installation section
            document.getElementById('installation-section').classList.add('hidden');
            
            // Initialize App Bridge (optional - app works without it)
            try {
                fetch('/api/config')
                    .then(response => response.json())
                    .then(config => {
                        // Corrected syntax for '.then'
                        console.log(config);
                    })
                    .catch(error => {
                        // Corrected syntax for '.catch'
                        console.error('Error:', error);
                    });
            } catch (error) {
                console.log('ℹ️ App Bridge initialization skipped:', error.message);
            }

            // Show authenticated sections
            showAuthenticatedApp(shop, accessToken);
            
            // Initialize media functionality
            initializeMediaFunctionality();
        }

        function initializeMediaFunctionality() {
            console.log('🎯 Initializing media functionality');
            
            // Set up event listeners for media buttons
            const fetchImagesBtn = document.getElementById('fetch-images-btn');
            const refreshImagesBtn = document.getElementById('refresh-images-btn');
            const fetchMetadataBtn = document.getElementById('fetch-metadata-btn');
            
            if (fetchImagesBtn) {
                fetchImagesBtn.addEventListener('click', fetchAllImages);
            }
            
            if (refreshImagesBtn) {
                refreshImagesBtn.addEventListener('click', refreshImages);
            }
            
            if (fetchMetadataBtn) {
                fetchMetadataBtn.addEventListener('click', reAnalyzeImages);
            }
            
            // Initialize disconnect button
            const disconnectBtn = document.getElementById('disconnect-btn');
            if (disconnectBtn) {
                disconnectBtn.addEventListener('click', disconnectStore);
            }
            
            console.log('✅ Media functionality initialized');
        }

        function showManualConnection() {
            console.log('Showing manual connection interface');
            
            // Hide installation section
            document.getElementById('installation-section').classList.add('hidden');
            
            // Show auth section
            document.getElementById('auth-section').classList.remove('hidden');
            
            // Set up connect button
            const connectBtn = document.getElementById('connect-btn');
            if (connectBtn) {
                connectBtn.addEventListener('click', function() {
                    const shop = prompt('Enter your Shopify store domain (e.g., your-store.myshopify.com):');
                    if (shop) {
                        startOAuthFlow(shop);
                    }
                });
            }
        }

        function showCustomAppPrompt(shop) {
            console.log('Showing custom app prompt for shop:', shop);
            
            // Hide installation section
            document.getElementById('installation-section').classList.add('hidden');
            
            // Show auth section
            document.getElementById('auth-section').classList.remove('hidden');
            
            // Update UI to show the shop
            document.getElementById('store-name').textContent = shop;
            document.getElementById('store-domain').textContent = shop;
            
            showNotification(`Custom app access for ${shop}. Please provide access token.`, 'info');
        }

        function startOAuthFlow(shop) {
            console.log('Starting OAuth flow for shop:', shop);
            
            // Get API key from server
            fetch('/api/config')
                .then(response => response.json())
                .then(config => {
                    const scopes = 'read_products,write_products,read_themes,write_themes';
                    const redirectUri = encodeURIComponent(window.location.origin + '/auth-callback.html');
                    const state = Math.random().toString(36).substring(7);
                    
                    const authUrl = `https://${shop}/admin/oauth/authorize?` +
                        `client_id=${config.apiKey}&` +
                        `scope=${encodeURIComponent(scopes)}&` +
                        `redirect_uri=${redirectUri}&` +
                        `state=${state}`;
                    
                    console.log('Redirecting to OAuth:', authUrl);
                    window.location.href = authUrl;
                })
                .catch(error => {
                    console.error('Failed to get API config:', error);
                    showNotification('Failed to start connection process', 'error');
                });
        }

        function disconnectStore() {
            console.log('Disconnecting store');
            
            // Clear stored credentials
            localStorage.removeItem('shopify_shop');
            localStorage.removeItem('shopify_token');
            
            // Clear session data
            imageSession.clear();
            
            // Reset app state
            window.shopifyApp.shop = null;
            window.shopifyApp.accessToken = null;
            
            // Hide authenticated sections
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('media-section').classList.add('hidden');
            document.getElementById('stats-section').classList.add('hidden');
            
            // Show installation section
            document.getElementById('installation-section').classList.remove('hidden');
            
            showNotification('Successfully disconnected', 'success');
            
            // Reload page to reset state
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        async function fetchAllImages() {
            console.log('🔄 Fetching all images...');
            
            if (!window.shopifyApp.shop || !window.shopifyApp.accessToken) {
                showNotification('Not connected to a Shopify store', 'error');
                return;
            }
            
            const statusEl = document.getElementById('images-status');
            const fetchBtn = document.getElementById('fetch-images-btn');
            
            try {
                // Update UI
                if (statusEl) statusEl.textContent = 'Fetching images...';
                if (fetchBtn) fetchBtn.disabled = true;
                
                const response = await fetch('/api/media/fetch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        shop: window.shopifyApp.shop,
                        accessToken: window.shopifyApp.accessToken
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.images) {
                    // Save to session
                    imageSession.save(data.images, window.shopifyApp.shop);
                    
                    // Display images
                    displayImages(data.images, 'All Images');
                    
                    // Update stats and filters
                    updateStats(data.images);
                    updateFilterCounts(data.images);
                    
                    // Show image filters
                    document.getElementById('image-filters').classList.remove('hidden');
                    
                    // Update status
                    if (statusEl) statusEl.textContent = `Loaded ${data.images.length} images`;
                    
                    showNotification(`Successfully loaded ${data.images.length} images`, 'success');
                    
                    // Automatically start comprehensive analysis after a short delay
                    setTimeout(() => {
                        reAnalyzeImages();
                    }, 1000);
                } else {
                    throw new Error(data.error || 'Failed to fetch images');
                }
                
            } catch (error) {
                console.error('Error fetching images:', error);
                if (statusEl) statusEl.textContent = 'Error loading images';
                showNotification(`Error: ${error.message}`, 'error');
            } finally {
                if (fetchBtn) fetchBtn.disabled = false;
            }
        }

        async function refreshImages() {
            console.log('🔄 Refreshing images...');
            
            // Clear session first
            imageSession.clear();
            
            // Fetch new images
            await fetchAllImages();
        }

        async function reAnalyzeImages() {
            console.log('🔍 Re-analyzing images with comprehensive analysis...');
            
            if (!imageSession.load() || !imageSession.isValid(window.shopifyApp.shop)) {
                showNotification('No images loaded. Please fetch images first.', 'error');
                return;
            }
            
            // Check if ImageOptimizer is available
            if (!window.ImageOptimizer || !window.ImageOptimizer.analyzeImageSize) {
                console.error('ImageOptimizer not loaded');
                showNotification('Image analysis tools not loaded. Please refresh the page.', 'error');
                return;
            }
            
            const statusEl = document.getElementById('images-status');
            const analyzeBtn = document.getElementById('fetch-metadata-btn');
            const images = imageSession.images;
            
            try {
                // Show enhanced UI during analysis
                disableInterface();
                
                if (statusEl) statusEl.textContent = 'Starting comprehensive image analysis...';
                if (analyzeBtn) {
                    analyzeBtn.disabled = true;
                    analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
                }
                
                // First, do client-side analysis with ImageOptimizer
                let processed = 0;
                const totalImages = images.length;
                
                // Process images in batches for better performance
                const batchSize = 5;
                for (let i = 0; i < totalImages; i += batchSize) {
                    const batch = images.slice(i, i + batchSize);
                    
                    await Promise.all(batch.map(async (image, batchIndex) => {
                        const index = i + batchIndex;
                        
                        try {
                            // Get file size and dimensions in parallel
                            const [size, dimensions] = await Promise.all([
                                getFileSize(image.url),
                                getImageDimensions(image.url)
                            ]);
                            
                            // Determine image type based on category
                            let imageType = 'product'; // default
                            if (image.category === 'collections') {
                                imageType = 'collection';
                            } else if (image.category === 'theme') {
                                // For theme images, try to guess type from filename/path
                                const url = image.url.toLowerCase();
                                if (url.includes('banner') || url.includes('hero') || url.includes('slider')) {
                                    imageType = 'banner';
                                } else if (url.includes('thumb') || url.includes('icon') || url.includes('logo')) {
                                    imageType = 'thumbnail';
                                } else {
                                    imageType = 'banner'; // default for theme images
                                }
                            }
                            
                            // Use the image optimizer to analyze the image
                            const analysisResult = window.ImageOptimizer.analyzeImageSize({
                                id: image.url,
                                src: image.url,
                                width: dimensions.width,
                                height: dimensions.height,
                                sizeInBytes: size,
                                type: imageType
                            });
                            
                            // Update image object with comprehensive analysis results
                            image.size = size;
                            image.sizeFormatted = analysisResult.sizeFormatted;
                            image.isLarge = analysisResult.oversized;
                            image.width = dimensions.width;
                            image.height = dimensions.height;
                            image.type = inferImageType(image.url); // Use URL-based type inference
                            image.aspectRatio = dimensions.width && dimensions.height ? 
                                (dimensions.width / dimensions.height).toFixed(2) : 'unknown';
                            image.imageType = imageType;
                            image.oversized = analysisResult.oversized;
                            image.oversizeReasons = analysisResult.reasons;
                            image.totalPixels = dimensions.width * dimensions.height;
                            
                        } catch (error) {
                            console.warn(`Failed to analyze image ${index}:`, error);
                            // Keep original "Not checked" values
                        }
                        
                        processed++;
                    }));
                    
                    // Update progress
                    const progress = Math.round((processed / totalImages) * 100);
                    if (statusEl) statusEl.textContent = `Analyzing images... ${progress}% (${processed}/${totalImages})`;
                    
                    // Update overlay progress text if it exists
                    const progressText = document.getElementById('analysis-progress-text');
                    if (progressText) {
                        progressText.textContent = `Analyzed ${processed} of ${totalImages} images (${progress}%)`;
                    }
                    
                    // Small delay between batches to prevent browser freezing
                    if (i + batchSize < totalImages) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }
                
                // Then do server-side analysis for additional metadata
                const response = await fetch('/api/media/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        shop: window.shopifyApp.shop,
                        accessToken: window.shopifyApp.accessToken,
                        images: images
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.images) {
                    // Update session with analyzed data
                    imageSession.save(data.images, window.shopifyApp.shop);
                    
                    // Update display
                    displayImages(data.images, 'All Images (Analyzed)');
                    updateStats(data.images);
                    updateFilterCounts(data.images);
                    
                    // Create file type filters based on analyzed images
                    createFileTypeFilters(data.images);
                    
                    const largeFiles = data.images.filter(img => img.isLarge).length;
                    if (statusEl) statusEl.textContent = `Analysis complete: ${data.images.length} images processed`;
                    showNotification(`Image analysis complete! Processed ${data.images.length} images. Found ${largeFiles} oversized files.`, 'success');
                } else {
                    throw new Error(data.error || 'Failed to analyze images');
                }
                
            } catch (error) {
                console.error('Error analyzing images:', error);
                if (statusEl) statusEl.textContent = 'Error analyzing images';
                showNotification(`Error: ${error.message}`, 'error');
            } finally {
                // Re-enable interface
                enableInterface();
                
                if (analyzeBtn) {
                    analyzeBtn.disabled = false;
                    analyzeBtn.innerHTML = '<i class="fas fa-info-circle"></i> Re-analyze Images';
                }
            }
        }
        
        // Helper functions for comprehensive analysis functionality
        
        // Helper functions to disable/enable interface during analysis
        function disableInterface() {
            // Disable all buttons
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => {
                if (!btn.disabled) {
                    btn.setAttribute('data-was-enabled', 'true');
                    btn.disabled = true;
                }
            });
            
            // Disable all inputs
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (!input.disabled) {
                    input.setAttribute('data-was-enabled', 'true');
                    input.disabled = true;
                }
            });
            
            // Add analyzing overlay to prevent clicks
            const overlay = document.createElement('div');
            overlay.id = 'analyzing-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(49, 42, 114, 0.3);
                z-index: 9999;
                cursor: not-allowed;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(2px);
            `;
            overlay.innerHTML = `
                <div style="
                    background: white;
                    padding: 30px;
                    border-radius: 16px;
                    box-shadow: 0 8px 25px rgba(49, 42, 114, 0.15);
                    text-align: center;
                    max-width: 400px;
                    margin: 20px;
                ">
                    <div style="
                        width: 40px;
                        height: 40px;
                        border: 4px solid #f3f3f3;
                        border-top: 4px solid #312A72;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                        margin: 0 auto 20px;
                    "></div>
                    <h3 style="color: #312A72; margin-bottom: 10px; font-family: 'Lexend', sans-serif;">Analyzing Images</h3>
                    <p id="analysis-progress-text" style="color: #6c757d; margin: 0; font-family: 'Lexend', sans-serif;">Starting comprehensive image analysis...</p>
                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 12px; color: #666;">
                        <p style="margin: 0;"><strong>What we're analyzing:</strong></p>
                        <p style="margin: 5px 0 0 0;">• File sizes and dimensions<br>• Image optimization opportunities<br>• Oversized image detection</p>
                    </div>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
            document.body.appendChild(overlay);
        }
        
        function enableInterface() {
            // Re-enable buttons that were previously enabled
            const buttons = document.querySelectorAll('button[data-was-enabled="true"]');
            buttons.forEach(btn => {
                btn.disabled = false;
                btn.removeAttribute('data-was-enabled');
            });
            
            // Re-enable inputs that were previously enabled
            const inputs = document.querySelectorAll('input[data-was-enabled="true"], select[data-was-enabled="true"], textarea[data-was-enabled="true"]');
            inputs.forEach(input => {
                input.disabled = false;
                input.removeAttribute('data-was-enabled');
            });
            
            // Remove analyzing overlay
            const overlay = document.getElementById('analyzing-overlay');
            if (overlay) {
                overlay.remove();
            }
        }
        
        // Function to get image dimensions
        function getImageDimensions(url) {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = function() {
                    resolve({
                        width: this.naturalWidth,
                        height: this.naturalHeight,
                        type: url.split('.').pop().toLowerCase()
                    });
                };
                img.onerror = function() {
                    resolve({
                        width: 0,
                        height: 0,
                        type: 'unknown'
                    });
                };
                img.src = url;
            });
        }
        
        // Function to get file size via HEAD request
        async function getFileSize(url) {
            try {
                const response = await fetch(url, { method: 'HEAD' });
                const size = parseInt(response.headers.get('content-length')) || 0;
                return size;
            } catch (error) {
                return 0;
            }
        }
        
        // Create file type filters based on analyzed images
        function createFileTypeFilters(images) {
            const fileTypes = {};
            images.forEach(img => {
                const type = img.type || 'UNKNOWN';
                fileTypes[type] = (fileTypes[type] || 0) + 1;
            });
            
            const filterContainer = document.getElementById('file-type-filters');
            if (filterContainer) {
                filterContainer.innerHTML = Object.entries(fileTypes)
                    .sort(([,a], [,b]) => b - a)
                    .map(([type, count]) => `
                        <button class="filter-btn" data-type="${type}">
                            ${type} (${count})
                        </button>
                    `).join('');
                
                // Add event listeners to filter buttons
                filterContainer.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const type = btn.dataset.type;
                        const filteredImages = images.filter(img => img.type === type);
                        displayImages(filteredImages, `${type} Images`);
                    });
                });
            }
        }
        
        // Helper function to update stats from images array
        function updateStats(images) {
            const totalFiles = images.length;
            const largeFiles = images.filter(img => img.isLarge).length;
            const totalSize = images.reduce((sum, img) => sum + (img.size || 0), 0);
            
            document.getElementById('total-files').textContent = totalFiles;
            document.getElementById('total-size').textContent = formatFileSize(totalSize);
            document.getElementById('oversized-count').textContent = largeFiles;
        }
        
        // Helper function to format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Helper function for formatting bytes (client-side)
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showAuthenticatedApp(shop, accessToken) {
            // Update store info
            document.getElementById('store-name').textContent = shop;
            document.getElementById('store-domain').textContent = shop;
            
            // Show connection status as connected and hide connect button
            const statusEl = document.getElementById('connection-status');
            const connectBtn = document.getElementById('connect-btn');
            const storeInfo = document.getElementById('store-info');
            
            statusEl.className = 'status-connected';
            statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Connected';
            connectBtn.classList.add('hidden');
            storeInfo.classList.remove('hidden');
            
            // Show all app sections
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('media-section').classList.remove('hidden');
            document.getElementById('stats-section').classList.remove('hidden');
            
            // Hide installation section
            document.getElementById('installation-section').classList.add('hidden');
            
            showNotification('Successfully connected to ' + shop, 'success');
        }

        function showNotification(message, type = 'info') {
            const notifications = document.getElementById('notifications');
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">&times;</button>
            `;
            notifications.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function displayImages(images, title) {
            const gallery = document.getElementById('image-gallery');
            gallery.innerHTML = '';

            if (!images || images.length === 0) {
                gallery.innerHTML = `
                    <div class="no-images">
                        <i class="fas fa-images"></i>
                        <h3>No images to display</h3>
                        <p>Try fetching images from your store or adjusting your filters.</p>
                    </div>
                `;
                return;
            }

            const header = document.createElement('h3');
            header.textContent = title || 'Images';
            header.className = 'gallery-header';
            gallery.appendChild(header);

            const imageGrid = document.createElement('div');
            imageGrid.className = 'image-grid';
            
            images.forEach((image, index) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-item';
                
                // Create image container
                const imageContainer = document.createElement('div');
                imageContainer.className = 'image-container';
                
                // Create image element with lazy loading
                const img = document.createElement('img');
                img.src = image.url;
                img.alt = image.name || `Image ${index + 1}`;
                img.loading = 'lazy';
                img.onerror = function() {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0xMDAgMTAwTDEwMCAxMDBaIiBzdHJva2U9IiM5Q0E0QTgiIHN0cm9rZS13aWR0aD0iMiIvPgo8dGV4dCB4PSIxMDAiIHk9IjEwNSIgZmlsbD0iIzlDQTRBOCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIj5JbWFnZSBub3QgYXZhaWxhYmxlPC90ZXh0Pgo8L3N2Zz4K';
                };
                
                imageContainer.appendChild(img);
                
                // Add oversized indicator
                if (image.oversized) {
                    const oversizedBadge = document.createElement('div');
                    oversizedBadge.className = 'oversized-badge';
                    oversizedBadge.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Oversized';
                    imageContainer.appendChild(oversizedBadge);
                }
                
                // Create info section
                const infoSection = document.createElement('div');
                infoSection.className = 'image-info';
                
                // Image name
                const imageName = document.createElement('div');
                imageName.className = 'image-name';
                imageName.textContent = image.name || `Image ${index + 1}`;
                infoSection.appendChild(imageName);
                
                // Image metadata
                const imageMeta = document.createElement('div');
                imageMeta.className = 'image-meta';
                
                // Category
                const categorySpan = document.createElement('span');
                categorySpan.className = 'image-category';
                categorySpan.textContent = image.category || 'Unknown';
                imageMeta.appendChild(categorySpan);
                
                // Size
                if (image.sizeFormatted) {
                    const sizeSpan = document.createElement('span');
                    sizeSpan.className = 'image-size';
                    sizeSpan.textContent = image.sizeFormatted;
                    imageMeta.appendChild(sizeSpan);
                }
                
                // Type
                if (image.type) {
                    const typeSpan = document.createElement('span');
                    typeSpan.className = 'image-type';
                    typeSpan.textContent = image.type;
                    imageMeta.appendChild(typeSpan);
                }
                
                // Dimensions
                if (image.width && image.height) {
                    const dimensionsSpan = document.createElement('span');
                    dimensionsSpan.textContent = `${image.width}×${image.height}px`;
                    imageMeta.appendChild(dimensionsSpan);
                }
                
                infoSection.appendChild(imageMeta);
                
                // Oversized reasons
                if (image.oversized && image.oversizeReasons && image.oversizeReasons.length > 0) {
                    const oversizedReasons = document.createElement('div');
                    oversizedReasons.className = 'oversized-reasons';
                    oversizedReasons.innerHTML = `
                        <strong>Issues:</strong>
                        <ul>
                            ${image.oversizeReasons.map(reason => `<li>${reason}</li>`).join('')}
                        </ul>
                    `;
                    infoSection.appendChild(oversizedReasons);
                }
                
                // Action buttons
                const actions = document.createElement('div');
                actions.className = 'image-actions';
                
                // Selection checkbox
                const selectCheckbox = document.createElement('input');
                selectCheckbox.type = 'checkbox';
                selectCheckbox.className = 'image-select';
                selectCheckbox.dataset.imageUrl = image.url;
                selectCheckbox.onchange = updateSelectionCount;
                
                // View button
                const viewBtn = document.createElement('button');
                viewBtn.className = 'btn-icon';
                viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
                viewBtn.title = 'View image';
                viewBtn.onclick = () => window.open(image.url, '_blank');
                
                // Replace button
                const replaceBtn = document.createElement('button');
                replaceBtn.className = 'btn-icon';
                replaceBtn.innerHTML = '<i class="fas fa-upload"></i>';
                replaceBtn.title = 'Replace image';
                replaceBtn.onclick = () => showReplaceImageModal(image);
                
                actions.appendChild(selectCheckbox);
                actions.appendChild(viewBtn);
                actions.appendChild(replaceBtn);
                
                infoSection.appendChild(actions);
                
                // Assemble the image item
                imageItem.appendChild(imageContainer);
                imageItem.appendChild(infoSection);
                imageGrid.appendChild(imageItem);
            });
            
            gallery.appendChild(imageGrid);
            
            // Show download controls
            document.getElementById('download-controls').classList.remove('hidden');
            
            // Show re-analyze button
            document.getElementById('fetch-metadata-btn').classList.remove('hidden');
            
            // Update selection count
            updateSelectionCount();
        }
        
        // Update filter counts
        function updateFilterCounts(images) {
            const counts = {
                all: images.length,
                theme: images.filter(img => img.category === 'theme').length,
                products: images.filter(img => img.category === 'products').length,
                collections: images.filter(img => img.category === 'collections').length,
                oversized: images.filter(img => img.oversized || img.isLarge).length
            };
            
            Object.entries(counts).forEach(([filter, count]) => {
                const countEl = document.getElementById(`count-${filter}`);
                if (countEl) countEl.textContent = count;
            });
        }
        
        // Filter images by category
        function filterImages(category) {
            if (!imageSession.load()) return;
            
            const images = imageSession.images;
            let filteredImages = images;
            let title = 'All Images';
            
            switch (category) {
                case 'theme':
                    filteredImages = images.filter(img => img.category === 'theme');
                    title = 'Theme Images';
                    break;
                case 'products':
                    filteredImages = images.filter(img => img.category === 'products');
                    title = 'Product Images';
                    break;
                case 'collections':
                    filteredImages = images.filter(img => img.category === 'collections');
                    title = 'Collection Images';
                    break;
                case 'oversized':
                    filteredImages = images.filter(img => img.oversized || img.isLarge);
                    title = 'Oversized Images';
                    break;
            }
            
            displayImages(filteredImages, title);
            
            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === category);
            });
        }
        
        // Selection functions
        function selectAllImages() {
            document.querySelectorAll('.image-select').forEach(checkbox => {
                checkbox.checked = true;
            });
            updateSelectionCount();
        }
        
        function selectNoneImages() {
            document.querySelectorAll('.image-select').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectionCount();
        }
        
        function updateSelectionCount() {
            const selectedCount = document.querySelectorAll('.image-select:checked').length;
            document.getElementById('selection-count').textContent = `${selectedCount} selected`;
            
            const downloadSelectedBtn = document.getElementById('download-selected-btn');
            downloadSelectedBtn.disabled = selectedCount === 0;
        }
        
        // Download functions
        function downloadAllImages() {
            if (!imageSession.load()) return;
            downloadImages(imageSession.images, 'all-images');
        }
        
        function downloadSelectedImages() {
            const selectedUrls = Array.from(document.querySelectorAll('.image-select:checked'))
                .map(checkbox => checkbox.dataset.imageUrl);
            
            if (selectedUrls.length === 0) {
                showNotification('No images selected', 'warning');
                return;
            }
            
            const selectedImages = imageSession.images.filter(img => selectedUrls.includes(img.url));
            downloadImages(selectedImages, 'selected-images');
        }
        
        async function downloadImages(images, filename) {
            if (!images || images.length === 0) {
                showNotification('No images to download', 'warning');
                return;
            }
            
            showNotification(`Preparing download of ${images.length} images...`, 'info');
            
            try {
                const zip = new JSZip();
                const promises = [];
                
                images.forEach((image, index) => {
                    const promise = fetch(image.url)
                        .then(response => response.blob())
                        .then(blob => {
                            const extension = getFileExtension(image.url);
                            const filename = `image_${index + 1}_${image.category || 'unknown'}.${extension}`;
                            zip.file(filename, blob);
                        })
                        .catch(error => {
                            console.warn(`Failed to download image ${index + 1}:`, error);
                        });
                    
                    promises.push(promise);
                });
                
                await Promise.all(promises);
                
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(zipBlob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}-${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification(`Successfully downloaded ${images.length} images`, 'success');
            } catch (error) {
                console.error('Download failed:', error);
                showNotification('Download failed: ' + error.message, 'error');
            }
        }
        
        // Replace image modal
        function showReplaceImageModal(image) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3><i class="fas fa-upload"></i> Replace Image</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="current-image">
                            <h4>Current Image</h4>
                            <img src="${image.url}" alt="Current image" style="max-width: 200px; max-height: 200px;">
                            <div class="image-details">
                                <p><strong>Category:</strong> ${image.category || 'Unknown'}</p>
                                <p><strong>Dimensions:</strong> ${image.width || 'Unknown'}×${image.height || 'Unknown'}px</p>
                                <p><strong>Size:</strong> ${image.sizeFormatted || 'Unknown'}</p>
                                <p><strong>Type:</strong> ${image.type || 'Unknown'}</p>
                            </div>
                        </div>
                        
                        <div class="new-image">
                            <h4>New Image</h4>
                            <input type="file" id="new-image-file" accept="image/*" required>
                            <div class="upload-info">
                                <p>Select a new image to replace the current one.</p>
                                <p><small>Supported formats: JPG, PNG, GIF, WebP</small></p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="replaceImage('${image.url}', '${image.category}')">Replace Image</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // Replace image function
        async function replaceImage(originalUrl, category) {
            const fileInput = document.getElementById('new-image-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('Please select an image file', 'warning');
                return;
            }
            
            const formData = new FormData();
            formData.append('image', file);
            formData.append('originalUrl', originalUrl);
            formData.append('category', category);
            formData.append('shop', window.shopifyApp.shop);
            formData.append('accessToken', window.shopifyApp.accessToken);
            
            try {
                showNotification('Replacing image...', 'info');
                
                const response = await fetch('/api/media/replace', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Image replaced successfully!', 'success');
                    
                    // Close modal
                    document.querySelector('.modal').remove();
                    
                    // Refresh images
                    setTimeout(() => {
                        refreshImages();
                    }, 1000);
                } else {
                    throw new Error(result.error || 'Failed to replace image');
                }
            } catch (error) {
                console.error('Replace image error:', error);
                showNotification('Failed to replace image: ' + error.message, 'error');
            }
        }

        // Global error handler
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('Global error caught:', { message, source, lineno, colno, error });
            showNotification('An unexpected error occurred. Please try again.', 'error');
        };
    </script>
    
    <!-- External Scripts -->
    <!-- <script src="app.js"></script> --> <!-- Commented out to avoid conflicts -->
    
    <!-- SPREE Footer -->
    <footer class="spree-footer">
        <div class="footer-content">
            <div class="footer-logo">
                <img src="https://wearespree.com/img/spree-logo.svg" alt="SPREE Agency" class="footer-logo-img">
                <div class="footer-text">
                    <h4>SPREE Agency</h4>
                    <p>Professional Shopify Solutions</p>
                </div>
            </div>
            <div class="footer-links">
                <a href="https://wearespree.com" target="_blank" rel="noopener">
                    <i class="fas fa-globe"></i> Visit Our Website
                </a>
                <a href="https://wearespree.com/#contact" target="_blank" rel="noopener">
                    <i class="fas fa-envelope"></i> Contact Us
                </a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 SPREE Agency. All rights reserved.</p>
        </div>
    </footer>
</body>
</html>
