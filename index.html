<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>SPREE - Shopify Media Manager v3-DEBUG</title>
    <meta name="description" content="Professional Shopify media management tool by SPREE agency. Download, optimize, and reupload your store's media files with ease.">
    <meta name="keywords" content="Shopify, media manager, image optimization, SPREE, agency, e-commerce">
    <meta name="author" content="SPREE Agency">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://wearespree.com/img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://wearespree.com/img/favicon/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://wearespree.com/img/favicon/apple-touch-icon.png">
    <meta name="theme-color" content="#312A72">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://media-manager.wearespree.com/">
    <meta property="og:title" content="SPREE - Shopify Media Manager">
    <meta property="og:description" content="Professional Shopify media management tool by SPREE agency. Download, optimize, and reupload your store's media files with ease.">
    <meta property="og:image" content="https://wearespree.com/img/spree-logo.svg">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://media-manager.wearespree.com/">
    <meta property="twitter:title" content="SPREE - Shopify Media Manager">
    <meta property="twitter:description" content="Professional Shopify media management tool by SPREE agency. Download, optimize, and reupload your store's media files with ease.">
    <meta property="twitter:image" content="https://wearespree.com/img/spree-logo.svg">
    
    <!-- Google Fonts - Lexend -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- JSZip for creating ZIP files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Shopify App Bridge -->
    <script src="https://unpkg.com/@shopify/app-bridge@3"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="spree-branding">
                <img src="https://wearespree.com/img/spree-logo.svg" alt="SPREE Agency" class="spree-logo">
                <div class="app-title">
                    <h1><i class="fab fa-shopify"></i> Shopify Media Manager</h1>
                    <p>Download, optimize, and reupload your store's media files</p>
                    <span class="powered-by">Powered by SPREE Agency</span>
                </div>
            </div>
        </header>

        <!-- Installation/Loading Section -->
        <section id="installation-section" class="section">
            <div class="card">
                <div id="loading-state" class="loading-state">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p>Setting up your Shopify Media Manager...</p>
                </div>
                
                <div id="install-prompt" class="install-prompt hidden">
                    <h2><i class="fas fa-download"></i> Install Shopify Media Manager</h2>
                    <p>Click the button below to install and connect your Shopify store.</p>
                    <button id="install-btn" class="btn btn-primary">
                        <i class="fab fa-shopify"></i> Install App
                    </button>
                </div>

                <div id="auth-error" class="auth-error hidden">
                    <h2><i class="fas fa-exclamation-triangle"></i> Installation Required</h2>
                    <p>Please install this app through your Shopify admin panel.</p>
                    <button id="retry-auth" class="btn btn-secondary">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            </div>
        </section>

        <!-- Authentication Section -->
        <section id="auth-section" class="section hidden">
            <div class="card">
                <h2><i class="fas fa-key"></i> Store Connection</h2>
                <div id="connection-status" class="status-disconnected">
                    <i class="fas fa-times-circle"></i> Not Connected
                </div>
                <button id="connect-btn" class="btn btn-primary">
                    <i class="fab fa-shopify"></i> Connect to Shopify Store
                </button>
                <div id="store-info" class="store-info hidden">
                    <h3>Connected Store</h3>
                    <p><strong>Store:</strong> <span id="store-name"></span></p>
                    <p><strong>Domain:</strong> <span id="store-domain"></span></p>
                    <button id="disconnect-btn" class="btn btn-secondary">
                        <i class="fas fa-sign-out-alt"></i> Disconnect
                    </button>
                </div>
            </div>
        </section>

        <!-- Media Management Section -->
        <section id="media-section" class="section hidden">
            <div class="card">
                <h2><i class="fas fa-images"></i> Media Management</h2>
                
                <!-- Fetch All Images Button -->
                <div style="margin-bottom: 1em;">
                    <button id="fetch-images-btn" class="btn btn-primary">Fetch All Image Assets</button>
                    <button id="refresh-images-btn" class="btn btn-secondary" style="margin-left: 10px;">
                        <i class="fas fa-sync"></i> Refresh Images
                    </button>
                    <button id="fetch-metadata-btn" class="btn btn-info hidden" style="margin-left: 10px;">
                        <i class="fas fa-info-circle"></i> Re-analyze Images
                    </button>
                    <span id="images-status" style="margin-left: 1em; color: #888;"></span>
                </div>
                
                <!-- Image Filters -->
                <div id="image-filters" class="hidden" style="margin-bottom: 1em; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="filterImages('all')" class="btn btn-outline filter-btn active" data-filter="all">
                        <i class="fas fa-images"></i> All Images (<span id="count-all">0</span>)
                    </button>
                    <button onclick="filterImages('theme')" class="btn btn-outline filter-btn" data-filter="theme">
                        <i class="fas fa-palette"></i> Theme Images (<span id="count-theme">0</span>)
                    </button>
                    <button onclick="filterImages('products')" class="btn btn-outline filter-btn" data-filter="products">
                        <i class="fas fa-box"></i> Product Images (<span id="count-products">0</span>)
                    </button>
                    <button onclick="filterImages('collections')" class="btn btn-outline filter-btn" data-filter="collections">
                        <i class="fas fa-layer-group"></i> Collection Images (<span id="count-collections">0</span>)
                    </button>
                    <button onclick="filterImages('oversized')" class="btn btn-outline filter-btn" data-filter="oversized">
                        <i class="fas fa-exclamation-triangle"></i> Oversized Images (<span id="count-oversized">0</span>)
                    </button>
                    <div id="file-type-filters" class="file-type-filters" style="display: flex; gap: 8px; flex-wrap: wrap; margin-left: 10px; padding-left: 10px; border-left: 1px solid #ddd;">
                        <!-- File type filters will be dynamically added here after analysis -->
                    </div>
                </div>
                
                <!-- Image Gallery -->
                <div id="image-gallery" class="image-gallery"></div>
                
                <!-- Download Controls -->
                <div id="download-controls" class="download-controls hidden">
                    <div class="selection-controls">
                        <button onclick="selectAllImages()" class="btn btn-outline btn-small">
                            <i class="fas fa-check-double"></i> Select All
                        </button>
                        <button onclick="selectNoneImages()" class="btn btn-outline btn-small">
                            <i class="fas fa-times"></i> Select None
                        </button>
                        <span id="selection-count" class="selection-status">0 selected</span>
                    </div>
                    <div class="download-buttons">
                        <button id="download-all-btn" onclick="downloadAllImages()" class="btn btn-success">
                            <i class="fas fa-file-archive"></i> Download All as ZIP
                        </button>
                        <button id="download-selected-btn" onclick="downloadSelectedImages()" class="btn btn-info" disabled>
                            <i class="fas fa-file-archive"></i> Download Selected as ZIP
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Statistics Section -->
        <section id="stats-section" class="section hidden">
            <div class="card">
                <h2><i class="fas fa-chart-bar"></i> Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label">Total Files:</span>
                        <span id="total-files" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Total Size:</span>
                        <span id="total-size" class="stat-value">0 MB</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Oversized Files:</span>
                        <span id="oversized-count" class="stat-value">0</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Optimization Section -->
        <section id="optimization-section" class="section hidden">
            <div class="card">
                <h2><i class="fas fa-compress-arrows-alt"></i> Optimization Savings</h2>
                
                <div id="optimization-loading" class="optimization-loading hidden">
                    <div class="loading-spinner"></div>
                    <p>Calculating potential savings...</p>
                </div>
                
                <div id="optimization-results" class="optimization-results hidden">
                    <div class="savings-summary">
                        <div class="savings-card total-savings">
                            <div class="savings-icon">💾</div>
                            <div class="savings-content">
                                <h3>Total Potential Savings</h3>
                                <div class="savings-amount" id="total-savings-amount">0 MB</div>
                                <div class="savings-percent" id="total-savings-percent">0%</div>
                                <div class="savings-detail">
                                    <span id="optimizable-count">0</span> images can be optimized
                                </div>
                            </div>
                        </div>
                        
                        <div class="savings-breakdown">
                            <div class="savings-card compression-savings">
                                <div class="savings-icon">🗜️</div>
                                <div class="savings-content">
                                    <h4>Compression</h4>
                                    <div class="savings-amount" id="compression-savings">0 MB</div>
                                    <div class="savings-detail">Lossless optimization</div>
                                </div>
                            </div>
                            
                            <div class="savings-card resize-savings">
                                <div class="savings-icon">📐</div>
                                <div class="savings-content">
                                    <h4>Resizing</h4>
                                    <div class="savings-amount" id="resize-savings">0 MB</div>
                                    <div class="savings-detail"><span id="resizable-count">0</span> oversized images</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="optimization-settings">
                        <h4><i class="fas fa-cog"></i> Optimization Settings</h4>
                        <div class="settings-grid">
                            <div class="setting-item">
                                <label>Max Product Image Size:</label>
                                <span>2048 × 2048px</span>
                            </div>
                            <div class="setting-item">
                                <label>Max Banner Size:</label>
                                <span>2400 × 1200px</span>
                            </div>
                            <div class="setting-item">
                                <label>Max Collection Image:</label>
                                <span>1920 × 1080px</span>
                            </div>
                            <div class="setting-item">
                                <label>Compression Quality:</label>
                                <span>JPEG: 85%, WebP: 80%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="optimization-actions">
                        <button id="view-optimization-details" class="btn btn-info">
                            <i class="fas fa-list"></i> View Detailed Breakdown
                        </button>
                        <button id="download-optimization-report" class="btn btn-secondary">
                            <i class="fas fa-download"></i> Download Report
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Notifications -->
        <div id="notifications" class="notifications"></div>
    </div>

    <script>
        // Global app state
        window.shopifyApp = {
            shop: null,
            accessToken: null,
            bridge: null
        };

        // Session storage for images
        const imageSession = {
            images: [],
            lastFetched: null,
            shop: null,
            
            save: function(images, shop) {
                this.images = images;
                this.lastFetched = new Date().toISOString();
                this.shop = shop;
                sessionStorage.setItem('shopify_media_session', JSON.stringify({
                    images: this.images,
                    lastFetched: this.lastFetched,
                    shop: this.shop
                }));
                console.log(`Saved ${images.length} images to session for shop ${shop}`);
            },
            
            load: function() {
                try {
                    const stored = sessionStorage.getItem('shopify_media_session');
                    if (stored) {
                        const data = JSON.parse(stored);
                        this.images = data.images || [];
                        this.lastFetched = data.lastFetched;
                        this.shop = data.shop;
                        console.log(`Loaded ${this.images.length} images from session for shop ${this.shop}`);
                        return true;
                    }
                } catch (error) {
                    console.warn('Failed to load session data:', error);
                }
                return false;
            },
            
            clear: function() {
                this.images = [];
                this.lastFetched = null;
                this.shop = null;
                sessionStorage.removeItem('shopify_media_session');
                console.log('Cleared image session');
            },
            
            isValid: function(shop) {
                return this.shop === shop && this.images.length > 0 && this.lastFetched;
            },
            
            getAge: function() {
                if (!this.lastFetched) return 0;
                return (new Date() - new Date(this.lastFetched)) / 1000; // seconds
            }
        };

        // Utility function to extract file extension from URL, stripping query strings and fragments
        function getFileExtension(url) {
            return url.split('.').pop().split('?')[0].split('#')[0].toLowerCase();
        }

        // Check for URL parameters on page load
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const shop = urlParams.get('shop');
            const token = urlParams.get('token');
            const hmac = urlParams.get('hmac');
            const host = urlParams.get('host');

            console.log('Page loaded with params:', { shop, token: token ? 'present' : 'missing', hmac: hmac ? 'present' : 'missing' });
            console.log('Full URL:', window.location.href);
            console.log('Search params:', window.location.search);

            // Check for stored authentication first
            const storedShop = localStorage.getItem('shopify_shop');
            const storedToken = localStorage.getItem('shopify_token');

            if (shop && token) {
                // We have shop and token from OAuth callback - store them and initialize
                console.log('✅ OAuth success detected - storing credentials and initializing app');
                localStorage.setItem('shopify_shop', shop);
                localStorage.setItem('shopify_token', token);
                
                // Clean up URL parameters immediately
                const cleanUrl = window.location.protocol + '//' + window.location.host + window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
                
                // Initialize app with the new credentials
                validateAndInitializeApp(shop, token);
            } else if (storedShop && storedToken) {
                // Use stored authentication - but validate it first
                console.log('Found stored authentication for shop:', storedShop);
                validateAndInitializeApp(storedShop, storedToken);
            } else if (shop && hmac) {
                // This is an installation request from Shopify
                console.log('Installation request detected');
                showInstallPrompt(shop);
            } else if (shop && !hmac && !token) {
                // Custom app access - shop parameter but no auth
                console.log('Custom app access detected for shop:', shop);
                showCustomAppPrompt(shop);
            } else {
                // No shop parameter - show manual connection
                console.log('No shop parameter - showing manual connection');
                showManualConnection();
            }
        });

        async function validateAndInitializeApp(shop, accessToken) {
            console.log('Validating token for shop:', shop);
            
            try {
                const response = await fetch('/api/validate-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ shop, accessToken })
                });
                
                const result = await response.json();
                
                if (result.valid) {
                    console.log('Token is valid, initializing authenticated app');
                    initializeAuthenticatedApp(shop, accessToken);
                } else {
                    console.log('Token is invalid, clearing stored credentials');
                    localStorage.removeItem('shopify_shop');
                    localStorage.removeItem('shopify_token');
                    showNotification('Your session has expired. Please reconnect.', 'warning');
                    showManualConnection();
                }
            } catch (error) {
                console.error('Token validation failed:', error);
                showNotification('Failed to validate session. Please try reconnecting.', 'error');
                showManualConnection();
            }
        }

        function initializeAuthenticatedApp(shop, accessToken) {
            console.log('🚀 initializeAuthenticatedApp called with:', { shop, token: accessToken ? 'present' : 'missing' });
            
            window.shopifyApp.shop = shop;
            window.shopifyApp.accessToken = accessToken;
            
            console.log('✅ Credentials set in window.shopifyApp:', window.shopifyApp);

            // Hide installation section
            document.getElementById('installation-section').classList.add('hidden');
            
            // Initialize App Bridge (optional - app works without it)
            try {
                fetch('/api/config')
                    .then(response => response.json())
                    .then(config => {
                        // Corrected syntax for '.then'
                        console.log(config);
                    })
                    .catch(error => {
                        // Corrected syntax for '.catch'
                        console.error('Error:', error);
                    });
            } catch (error) {
                console.log('ℹ️ App Bridge initialization skipped:', error.message);
            }

            // Show authenticated sections
            showAuthenticatedApp(shop, accessToken);
            
            // Initialize media functionality
            initializeMediaFunctionality();
        }

        function initializeMediaFunctionality() {
            console.log('🎯 Initializing media functionality');
            
            // Set up event listeners for media buttons
            const fetchImagesBtn = document.getElementById('fetch-images-btn');
            const refreshImagesBtn = document.getElementById('refresh-images-btn');
            const fetchMetadataBtn = document.getElementById('fetch-metadata-btn');
            
            if (fetchImagesBtn) {
                fetchImagesBtn.addEventListener('click', fetchAllImages);
            }
            
            if (refreshImagesBtn) {
                refreshImagesBtn.addEventListener('click', refreshImages);
            }
            
            if (fetchMetadataBtn) {
                fetchMetadataBtn.addEventListener('click', reAnalyzeImages);
            }
            
            // Initialize disconnect button
            const disconnectBtn = document.getElementById('disconnect-btn');
            if (disconnectBtn) {
                disconnectBtn.addEventListener('click', disconnectStore);
            }
            
            console.log('✅ Media functionality initialized');
        }

        function showManualConnection() {
            console.log('Showing manual connection interface');
            
            // Hide installation section
            document.getElementById('installation-section').classList.add('hidden');
            
            // Show auth section
            document.getElementById('auth-section').classList.remove('hidden');
            
            // Set up connect button
            const connectBtn = document.getElementById('connect-btn');
            if (connectBtn) {
                connectBtn.addEventListener('click', function() {
                    const shop = prompt('Enter your Shopify store domain (e.g., your-store.myshopify.com):');
                    if (shop) {
                        startOAuthFlow(shop);
                    }
                });
            }
        }

        function showCustomAppPrompt(shop) {
            console.log('Showing custom app prompt for shop:', shop);
            
            // Hide installation section
            document.getElementById('installation-section').classList.add('hidden');
            
            // Show auth section
            document.getElementById('auth-section').classList.remove('hidden');
            
            // Update UI to show the shop
            document.getElementById('store-name').textContent = shop;
            document.getElementById('store-domain').textContent = shop;
            
            showNotification(`Custom app access for ${shop}. Please provide access token.`, 'info');
        }

        function startOAuthFlow(shop) {
            console.log('Starting OAuth flow for shop:', shop);
            
            // Get API key from server
            fetch('/api/config')
                .then(response => response.json())
                .then(config => {
                    const scopes = 'read_products,write_products,read_themes,write_themes';
                    const redirectUri = encodeURIComponent(window.location.origin + '/auth-callback.html');
                    const state = Math.random().toString(36).substring(7);
                    
                    const authUrl = `https://${shop}/admin/oauth/authorize?` +
                        `client_id=${config.apiKey}&` +
                        `scope=${encodeURIComponent(scopes)}&` +
                        `redirect_uri=${redirectUri}&` +
                        `state=${state}`;
                    
                    console.log('Redirecting to OAuth:', authUrl);
                    window.location.href = authUrl;
                })
                .catch(error => {
                    console.error('Failed to get API config:', error);
                    showNotification('Failed to start connection process', 'error');
                });
        }

        function disconnectStore() {
            console.log('Disconnecting store');
            
            // Clear stored credentials
            localStorage.removeItem('shopify_shop');
            localStorage.removeItem('shopify_token');
            
            // Clear session data
            imageSession.clear();
            
            // Reset app state
            window.shopifyApp.shop = null;
            window.shopifyApp.accessToken = null;
            
            // Hide authenticated sections
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('media-section').classList.add('hidden');
            document.getElementById('stats-section').classList.add('hidden');
            
            // Show installation section
            document.getElementById('installation-section').classList.remove('hidden');
            
            showNotification('Successfully disconnected', 'success');
            
            // Reload page to reset state
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        async function fetchAllImages() {
            console.log('🔄 Fetching all images...');
            
            if (!window.shopifyApp.shop || !window.shopifyApp.accessToken) {
                showNotification('Not connected to a Shopify store', 'error');
                return;
            }
            
            const statusEl = document.getElementById('images-status');
            const fetchBtn = document.getElementById('fetch-images-btn');
            
            try {
                // Update UI
                if (statusEl) statusEl.textContent = 'Fetching images...';
                if (fetchBtn) fetchBtn.disabled = true;
                
                const response = await fetch('/api/media/fetch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        shop: window.shopifyApp.shop,
                        accessToken: window.shopifyApp.accessToken
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.images) {
                    // Save to session
                    imageSession.save(data.images, window.shopifyApp.shop);
                    
                    // Display images
                    displayImages(data.images, 'All Images');
                    
                    // Update stats and filters
                    updateStats(data.images);
                    updateFilterCounts(data.images);
                    
                    // Show image filters
                    document.getElementById('image-filters').classList.remove('hidden');
                    
                    // Update status
                    if (statusEl) statusEl.textContent = `Loaded ${data.images.length} images`;
                    
                    showNotification(`Successfully loaded ${data.images.length} images`, 'success');
                } else {
                    throw new Error(data.error || 'Failed to fetch images');
                }
                
            } catch (error) {
                console.error('Error fetching images:', error);
                if (statusEl) statusEl.textContent = 'Error loading images';
                showNotification(`Error: ${error.message}`, 'error');
            } finally {
                if (fetchBtn) fetchBtn.disabled = false;
            }
        }

        async function refreshImages() {
            console.log('🔄 Refreshing images...');
            
            // Clear session first
            imageSession.clear();
            
            // Fetch new images
            await fetchAllImages();
        }

        async function reAnalyzeImages() {
            console.log('🔍 Re-analyzing images...');
            
            if (!imageSession.load() || !imageSession.isValid(window.shopifyApp.shop)) {
                showNotification('No images loaded. Please fetch images first.', 'error');
                return;
            }
            
            const statusEl = document.getElementById('images-status');
            const analyzeBtn = document.getElementById('fetch-metadata-btn');
            
            try {
                if (statusEl) statusEl.textContent = 'Re-analyzing images...';
                if (analyzeBtn) analyzeBtn.disabled = true;
                
                const response = await fetch('/api/media/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        shop: window.shopifyApp.shop,
                        accessToken: window.shopifyApp.accessToken,
                        images: imageSession.images
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.images) {
                    // Update session with analyzed data
                    imageSession.save(data.images, window.shopifyApp.shop);
                    
                    // Update display
                    displayImages(data.images, 'All Images (Analyzed)');
                    updateStats(data.images);
                    updateFilterCounts(data.images);
                    
                    if (statusEl) statusEl.textContent = `Analysis complete: ${data.images.length} images processed`;
                    showNotification('Image analysis completed', 'success');
                } else {
                    throw new Error(data.error || 'Failed to analyze images');
                }
                
            } catch (error) {
                console.error('Error analyzing images:', error);
                if (statusEl) statusEl.textContent = 'Error analyzing images';
                showNotification(`Error: ${error.message}`, 'error');
            } finally {
                if (analyzeBtn) analyzeBtn.disabled = false;
            }
        }

        // Helper function to update stats from images array
        function updateStats(images) {
            const totalFiles = images.length;
            const largeFiles = images.filter(img => img.isLarge).length;
            const totalSize = images.reduce((sum, img) => sum + (img.size || 0), 0);
            
            document.getElementById('total-files').textContent = totalFiles;
            document.getElementById('total-size').textContent = formatFileSize(totalSize);
            document.getElementById('oversized-count').textContent = largeFiles;
        }
        
        // Helper function to format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Helper function for formatting bytes (client-side)
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showAuthenticatedApp(shop, accessToken) {
            // Update store info
            document.getElementById('store-name').textContent = shop;
            document.getElementById('store-domain').textContent = shop;
            
            // Show connection status as connected and hide connect button
            const statusEl = document.getElementById('connection-status');
            const connectBtn = document.getElementById('connect-btn');
            const storeInfo = document.getElementById('store-info');
            
            statusEl.className = 'status-connected';
            statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Connected';
            connectBtn.classList.add('hidden');
            storeInfo.classList.remove('hidden');
            
            // Show all app sections
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('media-section').classList.remove('hidden');
            document.getElementById('stats-section').classList.remove('hidden');
            
            // Hide installation section
            document.getElementById('installation-section').classList.add('hidden');
            
            showNotification('Successfully connected to ' + shop, 'success');
        }

        function showNotification(message, type = 'info') {
            const notifications = document.getElementById('notifications');
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">&times;</button>
            `;
            notifications.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function displayImages(images, title) {
            console.log('🚀 displayImages called with', images.length, 'images');
            const gallery = document.getElementById('image-gallery');
            gallery.innerHTML = '';

            if (!images || images.length === 0) {
                gallery.innerHTML = '<div class="error">No images to display.</div>';
                return;
            }

            const header = document.createElement('h3');
            header.textContent = title || 'Images';
            gallery.appendChild(header);

            const list = document.createElement('ul');
            list.className = 'image-list';

            images.forEach((image, index) => {
                console.log('📸 Processing image', index, image.url);
                const listItem = document.createElement('li');
                listItem.className = 'image-list-item';
                listItem.setAttribute('data-image-index', index);

                // Selection checkbox
                const checkboxContainer = document.createElement('div');
                checkboxContainer.className = 'image-checkbox-container';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'image-checkbox';
                checkbox.id = `image-checkbox-${index}`;
                checkbox.addEventListener('change', () => updateSelectionCount());
                checkboxContainer.appendChild(checkbox);

                // Image thumbnail
                const thumbnail = document.createElement('img');
                thumbnail.src = image.url;
                thumbnail.alt = 'Image thumbnail';
                thumbnail.className = 'image-thumbnail';
                
                // Image details container
                const details = document.createElement('div');
                details.className = 'image-details';

                // File size
                const sizeEl = document.createElement('div');
                sizeEl.className = 'image-detail';
                sizeEl.innerHTML = `<strong>Size:</strong> ${image.sizeFormatted || formatFileSize(image.size || 0)}`;
                details.appendChild(sizeEl);

                // Dimensions
                const dimensionsEl = document.createElement('div');
                dimensionsEl.className = 'image-detail';
                const width = image.width || 0;
                const height = image.height || 0;
                dimensionsEl.innerHTML = `<strong>Dimensions:</strong> ${width} × ${height}px`;
                details.appendChild(dimensionsEl);

                // Oversized status
                const oversizedEl = document.createElement('div');
                oversizedEl.className = 'image-detail';
                const isOversized = image.isLarge || image.oversized;
                oversizedEl.innerHTML = `<strong>Oversized:</strong> <span class="oversized-${isOversized ? 'yes' : 'no'}">${isOversized ? 'Yes' : 'No'}</span>`;
                details.appendChild(oversizedEl);

                // URL (truncated for display)
                const urlEl = document.createElement('div');
                urlEl.className = 'image-detail url-detail';
                const truncatedUrl = image.url.length > 60 ? image.url.substring(0, 60) + '...' : image.url;
                urlEl.innerHTML = `<strong>URL:</strong> <span class="image-url" title="${image.url}">${truncatedUrl}</span>`;
                details.appendChild(urlEl);

                // Create buttons directly
                const openButton = document.createElement('a');
                openButton.href = image.url;
                openButton.target = '_blank';
                openButton.rel = 'noopener noreferrer';
                openButton.className = 'btn btn-outline btn-small open-image-btn';
                openButton.innerHTML = '<i class="fas fa-external-link-alt"></i> Open Image';
                openButton.style.cssText = 'margin-right: 8px; margin-top: 8px; display: inline-block;';
                details.appendChild(openButton);

                const replaceButton = document.createElement('button');
                replaceButton.className = 'btn btn-primary btn-small replace-image-btn';
                replaceButton.innerHTML = '<i class="fas fa-upload"></i> Replace';
                replaceButton.title = 'Replace this image with a new one';
                replaceButton.style.cssText = 'margin-top: 8px; display: inline-block;';
                replaceButton.onclick = () => {
                    console.log('Replace button clicked for image', index);
                    showReplaceImageModal(image, index);
                };
                details.appendChild(replaceButton);

                listItem.appendChild(checkboxContainer);
                listItem.appendChild(thumbnail);
                listItem.appendChild(details);
                list.appendChild(listItem);
            });

            gallery.appendChild(list);
            
            // Show download controls when images are displayed
            if (images.length > 0) {
                document.getElementById('download-controls').classList.remove('hidden');
                updateSelectionCount();
            }
        }

        function createFileTypeFilters(images) {
            const filterContainer = document.getElementById('file-type-filters');
            filterContainer.innerHTML = '';

            const fileTypeCounts = images.reduce((counts, image) => {
                const fileType = getFileExtension(image.url);
                counts[fileType] = (counts[fileType] || 0) + 1;
                return counts;
            }, {});

            Object.entries(fileTypeCounts).forEach(([fileType, count]) => {
                const filterButton = document.createElement('button');
                filterButton.className = 'filter-button';
                filterButton.textContent = `${fileType.toUpperCase()} (${count})`;
                filterButton.onclick = () => {
                    const filteredImages = images.filter(image => {
                        const imageFileType = getFileExtension(image.url);
                        return imageFileType === fileType;
                    });
                    displayImages(filteredImages, `Images (${fileType.toUpperCase()})`);
                };
                filterContainer.appendChild(filterButton);
            });

            const showAllButton = document.createElement('button');
            showAllButton.className = 'filter-button';
            showAllButton.textContent = 'All';
            showAllButton.onclick = () => displayImages(images, 'All Images');
            filterContainer.appendChild(showAllButton);
        }

        function updateFilterCounts(images) {
            const fileTypeCounts = images.reduce((counts, image) => {
                const fileType = getFileExtension(image.url);
                counts[fileType] = (counts[fileType] || 0) + 1;
                return counts;
            }, {});

            // Count images by category
            const categoryCounts = images.reduce((counts, image) => {
                const category = image.category || 'products'; // default to products if no category
                counts[category] = (counts[category] || 0) + 1;
                return counts;
            }, {});

            const totalFiles = images.length;
            const largeFiles = images.filter(img => img.isLarge).length;

            // Update stats
            document.getElementById('total-files').textContent = totalFiles;
            document.getElementById('oversized-count').textContent = largeFiles;

            // Update category counts in filter buttons
            document.getElementById('count-all').textContent = totalFiles;
            document.getElementById('count-theme').textContent = categoryCounts.theme || 0;
            document.getElementById('count-products').textContent = categoryCounts.products || 0;
            document.getElementById('count-collections').textContent = categoryCounts.collections || 0;
            document.getElementById('count-oversized').textContent = largeFiles;

            const filterContainer = document.getElementById('file-type-filters');
            filterContainer.innerHTML = '';

            Object.entries(fileTypeCounts).forEach(([fileType, count]) => {
                const filterButton = document.createElement('button');
                filterButton.className = 'filter-button';
                filterButton.textContent = `${fileType.toUpperCase()} (${count})`;
                filterButton.onclick = () => {
                    const filteredImages = images.filter(image => {
                        const imageFileType = getFileExtension(image.url);
                        return imageFileType === fileType;
                    });
                    displayImages(filteredImages, `Images (${fileType.toUpperCase()})`);
                };
                filterContainer.appendChild(filterButton);
            });

            const showAllButton = document.createElement('button');
            showAllButton.className = 'filter-button';
            showAllButton.textContent = 'All';
            showAllButton.onclick = () => displayImages(images, 'All Images');
            filterContainer.appendChild(showAllButton);
        }

        // Function to filter images by category (called by filter buttons)
        function filterImages(category) {
            console.log('Filtering images by category:', category);
            
            // Get current images from session
            if (!imageSession.load() || !imageSession.isValid(window.shopifyApp.shop)) {
                showNotification('No images loaded. Please fetch images first.', 'error');
                return;
            }
            
            const allImages = imageSession.images;
            let filteredImages;
            let title;
            
            // Filter images based on category
            if (category === 'all') {
                filteredImages = allImages;
                title = 'All Images';
            } else if (category === 'oversized') {
                filteredImages = allImages.filter(image => image.isLarge || image.oversized);
                title = 'Oversized Images';
            } else {
                filteredImages = allImages.filter(image => image.category === category);
                title = `${category.charAt(0).toUpperCase() + category.slice(1)} Images`;
            }
            
            // Display filtered images
            displayImages(filteredImages, title);
            
            // Update active filter button styling
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${category}"]`).classList.add('active');
            
            console.log(`Filtered to ${filteredImages.length} images for category: ${category}`);
        }

        function updateSelectionCount() {
            const checkboxes = document.querySelectorAll('.image-checkbox');
            const selectedCheckboxes = document.querySelectorAll('.image-checkbox:checked');
            const selectedCount = selectedCheckboxes.length;
            
            // Update the selection count display
            const selectionCount = document.getElementById('selection-count');
            if (selectionCount) {
                selectionCount.textContent = `${selectedCount} selected`;
            }
            
            // Update download buttons state
            const downloadSelectedBtn = document.getElementById('download-selected-btn');
            if (downloadSelectedBtn) {
                downloadSelectedBtn.disabled = selectedCount === 0;
            }
        }

        // Selection control functions
        function selectAllImages() {
            const checkboxes = document.querySelectorAll('.image-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            updateSelectionCount();
        }

        function selectNoneImages() {
            const checkboxes = document.querySelectorAll('.image-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectionCount();
        }

        // Download functions
        async function downloadAllImages() {
            if (!imageSession.load() || !imageSession.isValid(window.shopifyApp.shop)) {
                showNotification('No images loaded. Please fetch images first.', 'error');
                return;
            }

            const images = imageSession.images;
            await downloadImagesAsZip(images, 'all-images.zip');
        }

        async function downloadSelectedImages() {
            if (!imageSession.load() || !imageSession.isValid(window.shopifyApp.shop)) {
                showNotification('No images loaded. Please fetch images first.', 'error');
                return;
            }

            const selectedCheckboxes = document.querySelectorAll('.image-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                showNotification('No images selected. Please select images to download.', 'warning');
                return;
            }

            const selectedImages = [];
            selectedCheckboxes.forEach(checkbox => {
                const listItem = checkbox.closest('.image-list-item');
                const imageIndex = parseInt(listItem.getAttribute('data-image-index'));
                selectedImages.push(imageSession.images[imageIndex]);
            });

            await downloadImagesAsZip(selectedImages, `selected-images-${selectedImages.length}.zip`);
        }

        // ZIP download functionality
        async function downloadImagesAsZip(images, filename) {
            if (!window.JSZip) {
                showNotification('ZIP functionality not available', 'error');
                return;
            }

            try {
                showNotification('Preparing download...', 'info');
                
                const zip = new JSZip();
                const folder = zip.folder('images');
                
                // Generate CSV mapping file
                const csvContent = generateImageMappingCSV(images);
                zip.file('image-mapping.csv', csvContent);
                
                // Generate README file
                const readmeContent = generateReadmeContent(images);
                zip.file('README.md', readmeContent);
                
                // Download images with progress tracking
                let downloadedCount = 0;
                const totalImages = images.length;
                
                for (const image of images) {
                    try {
                        const response = await fetch(image.url);
                        if (response.ok) {
                            const blob = await response.blob();
                            const extension = getFileExtension(image.url) || 'jpg';
                            const sanitizedFilename = `image-${downloadedCount + 1}.${extension}`;
                            folder.file(sanitizedFilename, blob);
                        }
                        downloadedCount++;
                        
                        // Update progress
                        if (downloadedCount % 10 === 0 || downloadedCount === totalImages) {
                            showNotification(`Downloaded ${downloadedCount}/${totalImages} images...`, 'info');
                        }
                    } catch (error) {
                        console.warn('Failed to download image:', image.url, error);
                    }
                }
                
                // Generate and download ZIP
                showNotification('Generating ZIP file...', 'info');
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                
                // Create download link
                const url = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification(`Successfully downloaded ${downloadedCount} images as ${filename}`, 'success');
                
            } catch (error) {
                console.error('Error creating ZIP file:', error);
                showNotification('Failed to create ZIP file', 'error');
            }
        }

        // Generate CSV mapping file
        function generateImageMappingCSV(images) {
            const headers = ['Index', 'Filename', 'Original URL', 'Size (bytes)', 'Dimensions', 'Type', 'Category', 'Oversized'];
            const rows = [headers.join(',')];
            
            images.forEach((image, index) => {
                const extension = getFileExtension(image.url) || 'jpg';
                const filename = `image-${index + 1}.${extension}`;
                const dimensions = `${image.width || 0}x${image.height || 0}`;
                const isOversized = image.isLarge || image.oversized ? 'Yes' : 'No';
                
                const row = [
                    index + 1,
                    filename,
                    `"${image.url}"`,
                    image.size || 0,
                    dimensions,
                    image.type || extension.toUpperCase(),
                    image.category || 'Unknown',
                    isOversized
                ];
                
                rows.push(row.join(','));
            });
            
            return rows.join('\n');
        }

        // Generate README content
        function generateReadmeContent(images) {
            const totalSize = images.reduce((sum, img) => sum + (img.size || 0), 0);
            const oversizedCount = images.filter(img => img.isLarge || img.oversized).length;
            
            const categoryCounts = images.reduce((counts, image) => {
                const category = image.category || 'Unknown';
                counts[category] = (counts[category] || 0) + 1;
                return counts;
            }, {});
            
            return `# Shopify Media Export

## Summary
- **Total Images**: ${images.length}
- **Total Size**: ${formatFileSize(totalSize)}
- **Oversized Images**: ${oversizedCount}
- **Export Date**: ${new Date().toISOString().split('T')[0]}
- **Store**: ${window.shopifyApp.shop || 'Unknown'}

## Category Breakdown
${Object.entries(categoryCounts).map(([category, count]) => `- **${category}**: ${count} images`).join('\n')}

## Files Included
- **image-mapping.csv**: Detailed mapping of all images with metadata
- **images/**: Folder containing all downloaded images

## Usage
1. The images are numbered sequentially (image-1.jpg, image-2.png, etc.)
2. Use the image-mapping.csv file to match images to their original URLs
3. Each image retains its original format and quality

---
Generated by SPREE Shopify Media Manager
https://wearespree.com
`;
        }

        // Function to show replace image modal
        function showReplaceImageModal(image, index) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content replace-image-modal">
                    <div class="modal-header">
                        <h3><i class="fas fa-upload"></i> Replace Image</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="current-image-info">
                            <h4>Current Image</h4>
                            <div class="image-preview">
                                <img src="${image.url}" alt="Current image" style="max-width: 200px; max-height: 200px; object-fit: contain; border: 1px solid #ddd; border-radius: 8px;">
                                <div class="image-details" style="margin-top: 10px;">
                                    <p><strong>Size:</strong> ${image.sizeFormatted || formatFileSize(image.size || 0)}</p>
                                    <p><strong>Dimensions:</strong> ${image.width || 0} × ${image.height || 0}px</p>
                                    <p><strong>Type:</strong> ${(image.type || getFileExtension(image.url)).toUpperCase()}</p>
                                    <p><strong>Category:</strong> ${image.category || 'Unknown'}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="new-image-upload" style="margin-top: 20px;">
                            <h4>Select New Image</h4>
                            <div class="upload-area" id="upload-area-${index}" style="border: 2px dashed #312A72; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; background: #f8f9fa; transition: all 0.3s ease;">
                                <div class="upload-placeholder">
                                    <i class="fas fa-cloud-upload-alt fa-3x" style="color: #312A72; margin-bottom: 10px;"></i>
                                    <p>Click to select image or drag & drop</p>
                                    <p style="font-size: 12px; color: #666;">Supported formats: JPG, PNG, WebP, GIF (Max 10MB)</p>
                                </div>
                                <input type="file" id="file-input-${index}" accept="image/*" style="display: none;">
                            </div>
                            <div id="preview-area-${index}" style="margin-top: 15px; display: none;">
                                <h5>New Image Preview:</h5>
                                <img id="preview-image-${index}" style="max-width: 200px; max-height: 200px; object-fit: contain; border: 1px solid #ddd; border-radius: 8px;">
                                <div id="preview-details-${index}" style="margin-top: 10px; font-size: 14px; color: #666;"></div>
                            </div>
                        </div>
                        
                        <div class="replace-status" id="replace-status-${index}" style="margin-top: 15px; display: none;">
                            <div class="status-message"></div>
                            <div class="progress-bar" style="width: 100%; height: 6px; background: #f0f0f0; border-radius: 3px; overflow: hidden;">
                                <div class="progress-fill" style="height: 100%; background: #312A72; width: 0%; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="btn btn-primary" id="replace-btn-${index}" disabled onclick="replaceImage(${index})">
                            <i class="fas fa-upload"></i> Replace Image
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up file input handling
            const fileInput = document.getElementById(`file-input-${index}`);
            const uploadArea = document.getElementById(`upload-area-${index}`);
            const previewArea = document.getElementById(`preview-area-${index}`);
            const previewImage = document.getElementById(`preview-image-${index}`);
            const previewDetails = document.getElementById(`preview-details-${index}`);
            const replaceBtn = document.getElementById(`replace-btn-${index}`);
            
            // Upload area click handler
            uploadArea.addEventListener('click', () => fileInput.click());
            
            // Drag and drop handlers
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#ffcd00';
                uploadArea.style.backgroundColor = '#fffdf0';
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#312A72';
                uploadArea.style.backgroundColor = '#f8f9fa';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#312A72';
                uploadArea.style.backgroundColor = '#f8f9fa';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelection(files[0], index);
                }
            });
            
            // File input change handler
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelection(e.target.files[0], index);
                }
            });
            
            // Store the original image data for replacement
            window.replaceImageData = window.replaceImageData || {};
            window.replaceImageData[index] = {
                originalImage: image,
                originalIndex: index,
                newFile: null
            };
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // Handle file selection for image replacement
        function handleFileSelection(file, index) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showNotification('Please select a valid image file.', 'error');
                return;
            }
            
            // Validate file size (10MB limit)
            if (file.size > 10 * 1024 * 1024) {
                showNotification('File size must be less than 10MB.', 'error');
                return;
            }
            
            const previewArea = document.getElementById(`preview-area-${index}`);
            const previewImage = document.getElementById(`preview-image-${index}`);
            const previewDetails = document.getElementById(`preview-details-${index}`);
            const replaceBtn = document.getElementById(`replace-btn-${index}`);
            
            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                previewArea.style.display = 'block';
                
                // Get image dimensions
                const img = new Image();
                img.onload = function() {
                    previewDetails.innerHTML = `
                        <p><strong>Size:</strong> ${formatFileSize(file.size)}</p>
                        <p><strong>Dimensions:</strong> ${this.width} × ${this.height}px</p>
                        <p><strong>Type:</strong> ${file.type.split('/')[1].toUpperCase()}</p>
                    `;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
            
            // Enable replace button
            replaceBtn.disabled = false;
            
            // Store the file for replacement
            window.replaceImageData[index].newFile = file;
        }
        
        // Replace image function
        async function replaceImage(index) {
            const replaceData = window.replaceImageData[index];
            if (!replaceData || !replaceData.newFile) {
                showNotification('No file selected for replacement.', 'error');
                return;
            }
            
            const originalImage = replaceData.originalImage;
            const newFile = replaceData.newFile;
            const replaceBtn = document.getElementById(`replace-btn-${index}`);
            const statusDiv = document.getElementById(`replace-status-${index}`);
            const progressBar = statusDiv.querySelector('.progress-fill');
            const statusMessage = statusDiv.querySelector('.status-message');
            
            // Disable button and show status
            replaceBtn.disabled = true;
            replaceBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Replacing...';
            statusDiv.style.display = 'block';
            
            try {
                // Step 1: Upload new image
                statusMessage.textContent = 'Uploading new image...';
                progressBar.style.width = '25%';
                
                const formData = new FormData();
                formData.append('image', newFile);
                formData.append('shop', window.shopifyApp.shop);
                formData.append('accessToken', window.shopifyApp.accessToken);
                formData.append('originalUrl', originalImage.url);
                formData.append('category', originalImage.category || 'products');
                
                const uploadResponse = await fetch('/api/media/replace', {
                    method: 'POST',
                    body: formData
                });
                
                if (!uploadResponse.ok) {
                    const errorData = await uploadResponse.json();
                    throw new Error(errorData.error || 'Failed to upload image');
                }
                
                const uploadResult = await uploadResponse.json();
                
                // Step 2: Update Shopify
                statusMessage.textContent = 'Updating Shopify store...';
                progressBar.style.width = '75%';
                
                await new Promise(resolve => setTimeout(resolve, 1000)); // Small delay for UX
                
                // Step 3: Complete
                statusMessage.textContent = 'Image replaced successfully!';
                progressBar.style.width = '100%';
                
                // Update the image in the session and UI
                if (imageSession.images && imageSession.images[index]) {
                    imageSession.images[index] = {
                        ...imageSession.images[index],
                        url: uploadResult.newUrl,
                        size: uploadResult.size,
                        sizeFormatted: formatFileSize(uploadResult.size),
                        width: uploadResult.width,
                        height: uploadResult.height,
                        type: uploadResult.type,
                        lastModified: new Date().toISOString()
                    };
                    
                    // Save updated session
                    imageSession.save(imageSession.images, window.shopifyApp.shop);
                    
                    // Refresh the image display
                    displayImages(imageSession.images, 'All Images (Updated)');
                }
                
                showNotification(`Image replaced successfully! New size: ${formatFileSize(uploadResult.size)}`, 'success');
                
                // Close modal after success
                setTimeout(() => {
                    document.querySelector('.modal').remove();
                }, 2000);
                
            } catch (error) {
                console.error('Error replacing image:', error);
                statusMessage.textContent = 'Failed to replace image';
                progressBar.style.width = '0%';
                showNotification(`Failed to replace image: ${error.message}`, 'error');
                
                // Re-enable button
                replaceBtn.disabled = false;
                replaceBtn.innerHTML = '<i class="fas fa-upload"></i> Replace Image';
            }
        }

        // Global error handler
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('Global error caught:', { message, source, lineno, colno, error });
            showNotification('An unexpected error occurred. Please try again.', 'error');
        };
    </script>
    
    <!-- External Scripts -->
    <!-- <script src="app.js"></script> --> <!-- Commented out to avoid conflicts -->
    <script src="image-optimizer.js"></script>
    
    <!-- Initialize optimization functionality -->
    <script>
        console.log('Initialization script loaded');
        
        // Add optimization functionality after DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded - checking dependencies');
            
            if (!window.ImageOptimizer) {
                console.warn('ImageOptimizer not available');
            } else {
                console.log('ImageOptimizer loaded successfully');
            }
            
            // The calculateOptimizationSavings function should already exist in the main script
            console.log('Optimization functionality ready');
        });
    </script>
    
    <!-- SPREE Footer -->
    <footer class="spree-footer">
        <div class="footer-content">
            <div class="footer-logo">
                <img src="https://wearespree.com/img/spree-logo.svg" alt="SPREE Agency" class="footer-logo-img">
                <div class="footer-text">
                    <h4>SPREE Agency</h4>
                    <p>Professional Shopify Solutions</p>
                </div>
            </div>
            <div class="footer-links">
                <a href="https://wearespree.com" target="_blank" rel="noopener">
                    <i class="fas fa-globe"></i> Visit Our Website
                </a>
                <a href="https://wearespree.com/#contact" target="_blank" rel="noopener">
                    <i class="fas fa-envelope"></i> Contact Us
                </a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 SPREE Agency. All rights reserved.</p>
        </div>
    </footer>
</body>
</html>
